# 架构与存储方案（Vercel + Redis，可选）

## 1) 目标与约束

- **默认不存云端隐私数据**（尤其梦境）
- 允许做一个“短期找回/缓存”（7 天），降低用户挫败感
- 支持 Web + 小程序共享同一套 API（`/api/divine`）

## 2) 现状（项目里已经具备）

- Vercel 部署 Next.js（Web + API routes）
- Redis（通过 `REDIS_URL`）用于用户集合/签到等数据（`/api/user`）

## 3) 推荐的分层存储

### A. 本地永久（默认）

- **Web**：IndexedDB
  - key：`dream:<timestamp>` / `note:<id>`
  - 支持导出/导入 JSON（迁移与备份）
- **小程序**：`wx.setStorage`
  - 做分页结构：`dream-index`（列表）+ `dream-<id>`（详情）
  - 控制容量：例如最多保存 500 条，超出提示导出

### B. Redis 7 天缓存（可选开关）

用途：
- 用户换设备/清缓存/重装后，7 天内可找回最近记录

设计：
- key：`co:cache:<deviceId>:dream:<id>`
- TTL：7 天
- 存储内容：
  - 默认仅存“解析结果 + 牌 id + 时间戳”
  - 梦境原文：默认不存；若用户同意才存（且建议加密）

## 4) API 形态（建议）

### 4.1 `/api/divine`（生成解读）

- 输入尽量结构化（降低 token 与重复）
- 输出固定长度（按 mode 控 `max_tokens`）

### 4.2 `/api/notes`（未来新增：时间线）

如果只做本地：不需要这个接口。  
如果要 7 天游标缓存：
- `POST /api/notes/cache`：写入 7 天缓存（可选）
- `GET /api/notes/cache`：拉取最近 N 条（可选）

## 5) 风险与对策

- **隐私风险**：梦境默认不上传；缓存开关必须显式提示
- **成本风险**：topic 模式输入长、输出长 → 需要压缩输入 + 缓存
- **一致性风险**：Web 与小程序双端逻辑重复 → 通过“服务端组装 prompt 与牌义”降低重复（见代码复用方案文档）

